name: Deploy to Raspberry Pi (Self-Hosted)

on:
  push:
    branches:
      - main
    paths:
      - 'projects/pi5-trading-system/**'
      - '.github/workflows/deploy-pi5-self-hosted.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Build and Deploy
    runs-on: self-hosted  # Runs on your Raspberry Pi!

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: projects/pi5-trading-system/go.sum

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: projects/pi5-trading-system/dashboard/package-lock.json

      - name: Install migration tool
        run: |
          echo "ğŸ“¦ Installing migration tool..."
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

      - name: Build Go binaries
        working-directory: projects/pi5-trading-system
        run: |
          echo "ğŸ”¨ Building Go binaries..."
          go build -o api cmd/api/main.go
          go build -o backtest cmd/backtest/main.go
          go build -o optimize cmd/optimize/main.go

      - name: Build dashboard
        working-directory: projects/pi5-trading-system/dashboard
        run: |
          echo "ğŸ¨ Building dashboard..."
          npm ci
          npm run build
          echo "âœ“ Dashboard built to dist/"

      - name: Run tests (optional)
        working-directory: projects/pi5-trading-system
        run: |
          echo "ğŸ§ª Running tests..."
          go test ./... -short || true

      - name: Create backup
        run: |
          DEPLOY_DIR="$HOME/pi5-trading-system"
          BACKUP_DIR="$HOME/pi5-trading-backups"

          if [ -d "$DEPLOY_DIR" ]; then
            echo "ğŸ’¾ Creating backup..."
            mkdir -p $BACKUP_DIR
            BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S)"
            cp -r $DEPLOY_DIR "$BACKUP_DIR/$BACKUP_NAME"
            echo "âœ“ Backup created: $BACKUP_DIR/$BACKUP_NAME"

            # Keep only last 5 backups
            cd $BACKUP_DIR
            ls -t | tail -n +6 | xargs -r rm -rf
          fi

      - name: Stop service
        run: |
          echo "ğŸ›‘ Stopping service..."
          systemctl --user stop pi5-trading.service || true

      - name: Run database migrations
        working-directory: projects/pi5-trading-system
        run: |
          echo "ğŸ—„ï¸  Running database migrations..."

          # Source DB password from .env if it exists
          if [ -f "$HOME/pi5-trading-system/.env" ]; then
            export $(grep -v '^#' $HOME/pi5-trading-system/.env | xargs)
          fi

          DB_PASSWORD="${DB_PASSWORD:-dev-password}"

          ~/go/bin/migrate -path migrations \
            -database "postgres://pi5trader:${DB_PASSWORD}@localhost:5432/pi5_trading?sslmode=disable" \
            up || echo "âš ï¸  Migrations may have already been applied"

          echo "âœ“ Migrations complete"

      - name: Deploy binaries and assets
        working-directory: projects/pi5-trading-system
        run: |
          DEPLOY_DIR="$HOME/pi5-trading-system"
          mkdir -p $DEPLOY_DIR/{logs,configs,migrations,dashboard}

          echo "ğŸ“¦ Deploying binaries..."
          cp api backtest optimize $DEPLOY_DIR/
          chmod +x $DEPLOY_DIR/{api,backtest,optimize}

          echo "ğŸ“ Deploying configs..."
          cp -r configs/* $DEPLOY_DIR/configs/

          echo "ğŸ—„ï¸  Deploying migrations..."
          cp -r migrations/* $DEPLOY_DIR/migrations/

          echo "ğŸ¨ Deploying dashboard..."
          rm -rf $DEPLOY_DIR/dashboard/dist
          mkdir -p $DEPLOY_DIR/dashboard
          cp -r dashboard/dist $DEPLOY_DIR/dashboard/

          # Copy .env.example if .env doesn't exist
          if [ ! -f "$DEPLOY_DIR/.env" ]; then
            cp .env.example $DEPLOY_DIR/.env 2>/dev/null || echo "No .env.example found"
            echo "âš ï¸  Created .env from example - please configure it!"
          fi

          echo "âœ“ Deployment complete"

      - name: Start service
        run: |
          echo "ğŸš€ Starting service..."
          systemctl --user start pi5-trading.service
          sleep 3

      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."

          if systemctl --user is-active --quiet pi5-trading.service; then
            echo "âœ… Service is running"
            systemctl --user status pi5-trading.service --no-pager | head -10
          else
            echo "âŒ Service failed to start"
            journalctl --user -u pi5-trading.service -n 20 --no-pager
            exit 1
          fi

          echo ""
          echo "ğŸ“Š Deployment Summary:"
          ls -lh $HOME/pi5-trading-system/{api,backtest,optimize}

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi

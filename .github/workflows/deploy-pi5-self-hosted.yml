name: Deploy to Raspberry Pi (Self-Hosted)

on:
  push:
    branches:
      - main
    paths:
      - 'projects/pi5-trading-system/**'
      - '.github/workflows/deploy-pi5-self-hosted.yml'

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Build and Deploy
    runs-on: self-hosted  # Runs on your Raspberry Pi!

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: projects/pi5-trading-system/go.sum

      - name: Build binaries
        working-directory: projects/pi5-trading-system
        run: |
          echo "üî® Building binaries..."
          go build -o api cmd/api/main.go
          go build -o backtest cmd/backtest/main.go
          go build -o optimize cmd/optimize/main.go

      - name: Run tests (optional)
        working-directory: projects/pi5-trading-system
        run: |
          echo "üß™ Running tests..."
          go test ./... -short || true

      - name: Create backup
        run: |
          DEPLOY_DIR="$HOME/pi5-trading-system"
          BACKUP_DIR="$HOME/pi5-trading-backups"

          if [ -d "$DEPLOY_DIR" ]; then
            echo "üíæ Creating backup..."
            mkdir -p $BACKUP_DIR
            BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S)"
            cp -r $DEPLOY_DIR "$BACKUP_DIR/$BACKUP_NAME"
            echo "‚úì Backup created: $BACKUP_DIR/$BACKUP_NAME"

            # Keep only last 5 backups
            cd $BACKUP_DIR
            ls -t | tail -n +6 | xargs -r rm -rf
          fi

      - name: Stop service
        run: |
          echo "üõë Stopping service..."
          systemctl --user stop pi5-trading.service || true

      - name: Deploy binaries
        working-directory: projects/pi5-trading-system
        run: |
          DEPLOY_DIR="$HOME/pi5-trading-system"
          mkdir -p $DEPLOY_DIR/logs

          echo "üì¶ Deploying binaries..."
          cp api backtest optimize $DEPLOY_DIR/
          cp configs/config.yaml $DEPLOY_DIR/ || true

          # Copy .env.example if .env doesn't exist
          if [ ! -f "$DEPLOY_DIR/.env" ]; then
            cp .env.example $DEPLOY_DIR/.env
            echo "‚ö†Ô∏è  Created .env from example - please configure it!"
          fi

          # Make binaries executable
          chmod +x $DEPLOY_DIR/api
          chmod +x $DEPLOY_DIR/backtest
          chmod +x $DEPLOY_DIR/optimize

          echo "‚úì Binaries deployed"

      - name: Start service
        run: |
          echo "üöÄ Starting service..."
          systemctl --user start pi5-trading.service
          sleep 3

      - name: Verify deployment
        run: |
          echo "üîç Verifying deployment..."

          if systemctl --user is-active --quiet pi5-trading.service; then
            echo "‚úÖ Service is running"
            systemctl --user status pi5-trading.service --no-pager | head -10
          else
            echo "‚ùå Service failed to start"
            journalctl --user -u pi5-trading.service -n 20 --no-pager
            exit 1
          fi

          echo ""
          echo "üìä Deployment Summary:"
          ls -lh $HOME/pi5-trading-system/{api,backtest,optimize}

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Deployment successful!"
          else
            echo "‚ùå Deployment failed!"
          fi
